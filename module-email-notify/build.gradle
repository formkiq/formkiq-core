import org.apache.tools.ant.taskdefs.condition.Os

apply plugin: 'distribution'

description = "FormKiQ Core - Email Notify Module"

// -------------------------------
// Source sets & configurations
// -------------------------------
sourceSets {
  integration {
    java.srcDir "$projectDir/src/integration/java"
    resources.srcDir "$projectDir/src/integration/resources"
    compileClasspath += sourceSets.main.output + sourceSets.test.output
    runtimeClasspath += sourceSets.main.output + sourceSets.test.output
  }
}

configurations {
  integrationImplementation.extendsFrom testImplementation
  integrationRuntimeOnly.extendsFrom testRuntimeOnly
}

// -------------------------------
// Dependencies
// -------------------------------
dependencies {
  testImplementation project(':aws-cognito-identity')
  testImplementation project(':aws-cognito-identityprovider')
  testImplementation project(':aws-s3')
  testImplementation project(':aws-sqs')
  testImplementation project(':aws-ssm')
  testImplementation project(':aws-sns')

  testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-engine', version:'5.11.4'
  testImplementation group: 'com.google.code.gson', name: 'gson', version: '2.13.1'
}

// -------------------------------
// Testing
// -------------------------------
test {
  failFast = true
  useJUnitPlatform()
}

tasks.register('integrationTest', Test) {
  description = "Runs the integration tests."
  group = "verification"
  testClassesDirs = sourceSets.integration.output.classesDirs
  classpath = sourceSets.integration.runtimeClasspath
  useJUnitPlatform()
}

// Disable jar for this module (matches your original intent)
tasks.named('jar') { enabled = false }

// -------------------------------
//
// JS / NPM pipeline (moved out of build/resources/main to avoid overlap)
//
/* CHANGED:
 - Work under build/js, not build/resources/main/js
 - Add a prepareJs Copy task to stage package.json etc.
 */
def isWindows = Os.isFamily(Os.FAMILY_WINDOWS)
def shCmd = { String cmd -> isWindows ? ['cmd', '/c', cmd] : ['bash', '-c', cmd] }

// CHANGED: dedicated JS work dir
def jsDirProvider       = layout.buildDirectory.dir("js")
def jsDirFile           = { jsDirProvider.get().asFile }
def packedZipProvider   = jsDirProvider.map { it.file("module-email-notify.zip") }
def packOutDirProvider  = layout.buildDirectory.dir("pack")

// Stage JS sources into build/js (so npm runs outside of build/resources)
tasks.register('prepareJs', Copy) {
  description = "Stages JS sources into build/js for npm tasks."
  from("$projectDir/src/main/resources/js") {
    include "**/*"
  }
  into(jsDirProvider)
}

// Clean any previously packed zip so pack results are fresh
tasks.register('deletePackedZip', Delete) {
  delete packedZipProvider
}

// npm install in build/js
tasks.register('npmInstall', Exec) {
  group = "build"
  description = "Runs 'npm install' in build/js."
  dependsOn tasks.named('prepareJs'), tasks.named('deletePackedZip')

  workingDir = jsDirFile()
  commandLine shCmd("npm install")

  // Inputs/outputs for up-to-date checks
  inputs.files(
      fileTree("$projectDir/src/main/resources/js") {
        include 'package.json', 'package-lock.json', 'npm-shrinkwrap.json'
        // include any other files that affect dependency resolution
      }
      ).withPropertyName("npmInputs")
  outputs.dir(jsDirProvider.map { it.dir("node_modules") }).withPropertyName("nodeModules")
}

// npm run pack in build/js
tasks.register('npmPack', Exec) {
  group = "build"
  description = "Runs 'npm run pack' to create module-email-notify.zip in build/js."
  dependsOn tasks.named('npmInstall')
  workingDir = jsDirFile()
  commandLine shCmd("npm run pack")

  outputs.file(packedZipProvider).withPropertyName("packedZip")
}

// Optional: JS tests with LocalStack up/down around them (skips on Windows)
tasks.register('localstackUp', Exec) {
  group = "verification"
  description = "Starts docker compose stack for local testing."
  commandLine shCmd("docker compose -f ./docker-compose.yml --verbose up -d")
  outputs.upToDateWhen { false }
}

tasks.register('waitForLocalstack', Exec) {
  group = "verification"
  description = "Waits for LocalStack to be ready."
  commandLine shCmd("${project.rootDir}/wait-for-localstack.sh 4567")
  outputs.upToDateWhen { false }
}

tasks.register('localstackDown', Exec) {
  group = "verification"
  description = "Stops docker compose stack."
  commandLine shCmd("docker compose -f ./docker-compose.yml down")
  outputs.upToDateWhen { false }
}

tasks.register('npmTest', Exec) {
  group = "verification"
  description = "Runs 'npm test' (non-Windows only) with LocalStack."
  onlyIf { !isWindows }
  dependsOn tasks.named('localstackUp'), tasks.named('waitForLocalstack'), tasks.named('npmInstall')
  finalizedBy tasks.named('localstackDown')

  workingDir = jsDirFile()
  commandLine shCmd("npm test")
}

// Keep your linkage: run JS tests as part of 'test'
tasks.named('test') {
  dependsOn tasks.named('npmTest')
}

// -------------------------------
// CloudFormation template copy
// -------------------------------
tasks.register('buildTemplate', Copy) {
  group = "build"
  description = "Copies the CloudFormation template into the distribution dir."
  from "src/main/resources/cloudformation/template.yaml"
  into layout.buildDirectory.dir("distributions/module-email-notify")
}

// -------------------------------
// Unzip npm pack for distribution
// -------------------------------
tasks.register('unzipPack', Copy) {
  group = "build"
  description = "Unzips module-email-notify.zip into build/pack."
  dependsOn tasks.named('npmPack')

  from { zipTree(packedZipProvider.get().asFile) }
  into packOutDirProvider
}

// -------------------------------
// Distribution packaging
// -------------------------------
tasks.named('distTar') { enabled = false }

tasks.named('distZip') {
  dependsOn tasks.named('buildTemplate'),
      tasks.named('npmPack'),
      tasks.named('unzipPack')

  archiveFileName = "module-email-notify/module-email-notify.zip"
}

distributions {
  main {
    contents {
      from(packOutDirProvider) { include "**/**" }
      into '/'
    }
  }
}
